<!DOCTYPE html>
<html lang="en-CN">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="ä»‹ç»ä¸»è¦åŠŸèƒ½">
<meta name="author" content="codefuse-ai">

<title>MFTCoder: Accelerate &#43; DeepSpeed/FSDP æ¡†æ¶ç¯‡ Â· CodeFuse-AI</title>

<link rel="canonical" href="/docs/mftcoder-accelerate-zh/">









<link rel="stylesheet" href="/scss/base.css" integrity="">



<link rel="stylesheet" href="/scss/theme/default.css" integrity="">



<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/img/icon/favicon.ico">
<link rel="icon" href="/img/icon/icon-16.png" sizes="16x16" type="image/png">
<link rel="icon" href="/img/icon/icon-32.png" sizes="32x32" type="image/png">
<link rel="apple-touch-icon" href="/img/icon/icon-180.png" sizes="180x180">
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#121212" media="(prefers-color-scheme: dark)">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-xxxx"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-xxxx');
</script>


  
  

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css">
  </head>
  <body>
    <header id="site-header">
  
  <div id="site-header-brand">
    <a href="/">CodeFuse-AI</a>
  </div>

  
  <div id="site-header-controls">
    
    <div class="dropdown">
      <button class="dropdown-btn" aria-haspopup="menu" aria-label="theme selector">
        <i class="icon icon-brightness"></i>
        <i class="icon icon-select"></i>
      </button>
      <ul role="menu" class="dropdown-menu">
        <li role="menuitem"><button class="color-scheme" data-value="light"><i class="icon icon-light-mode"></i> Light</button></li>
        <li role="menuitem"><button class="color-scheme" data-value="dark"><i class="icon icon-dark-mode"></i> Dark &nbsp;</button></li>
        <li role="menuitem"><button class="color-scheme" data-value="night"><i class="icon icon-night-mode"></i> Night</button></li>
      </ul>
    </div>

    
    <div class="dropdown">
      <button class="dropdown-btn" aria-haspopup="menu" aria-label="language selector">
        <i class="icon icon-translate"></i>
        <i class="icon icon-select"></i>
      </button>
      <ul role="menu" class="dropdown-menu">
        
          
          <li role="menuitem"><a href="/docs/mftcoder-accelerate/">English</a></li>
          
          <li role="menuitem"><a href="/docs/mftcoder-accelerate-zh/">ä¸­æ–‡</a></li>
          
        
      </ul>
    </div>
  </div>

  
  <div id="site-header-menu">
    <nav>
      <ul>
        
        
        
          
          <li><a href="/" ><i class='icon icon-home'></i>Home</a></li>
        
          
          <li><a href="/docs"  class="active"><i class='icon icon-book'></i>Overview</a></li>
        
          
          <li><a href="/muagent" ><i class='icon icon-book'></i>MuAgent</a></li>
        
          
          <li><a href="/contribution" ><i class='icon icon-book'></i>Contribution</a></li>
        
      </ul>
    </nav>
  </div>

  
  <div id="site-header-search"></div>
</header>
    
<div id="site-main-content-wrapper">
  
  
    <aside id="sidebar">
  <span class="btn-close"><i class="icon icon-close"></i></span>

  <div class="sticky"><strong class="sidebar-section">ğŸ“– CodeFuse-AI æ•´ä½“ä»‹ç»</strong>
          
          <a class="sidebar-link " href="/docs/%E6%A6%82%E8%A7%88/">
            
              æ¦‚è§ˆ
            
          </a>

        <strong class="sidebar-section">ğŸ“– CodeFuse-AI æ¨¡å—</strong>
          
          <a class="sidebar-link " href="/docs/codefuse-query-zh/">
            
              CodeFuse-Query
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/mftcoder-zh/">
            
              MFTCoder
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/codefuse-mft-vlm-zh/">
            
              CodeFuse-MFT-VLM
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/test-agent-zh/">
            
              Test-Agent
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/codefuse-modelcache-zh/">
            
              CodeFuse-ModelCache
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/codefuse-chatbot-zh/">
            
              CodeFuse-ChatBot
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/codefuse-devops-eval-zh/">
            
              CodeFuse-DevOps-Eval
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/codefuse-devops-model-zh/">
            
              CodeFuse-DevOps-Model
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/codefuse-evalution-zh/">
            
              CodeFuse-Evalution
            
          </a>

        <strong class="sidebar-section">CodeFuse-Query</strong>
          
          <a class="sidebar-link " href="/docs/codefuse-query-introduction-zh/">
            
              åŸºæœ¬ä»‹ç»
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/codefuse-query-quickstart-zh/">
            
              å¿«é€Ÿå¼€å§‹
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/codefuse-query-godellanguage-zh/">
            
              æŸ¥è¯¢è¯­è¨€ä»‹ç»
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/codefuse-query-toolchain-zh/">
            
              VSCodeæ’ä»¶
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/codefuse-query-usercase-zh/">
            
              ç”¨æˆ·æ¡ˆä¾‹
            
          </a>

        <strong class="sidebar-section">MFTCoder</strong>
          
          <a class="sidebar-link " href="/docs/mftcoder-introduction-zh/">
            
              åŸºæœ¬ä»‹ç»
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/mftcoder-quickstart-zh/">
            
              å¿«é€Ÿä½¿ç”¨
            
          </a>

        
          
          <a class="sidebar-link current" href="/docs/mftcoder-accelerate-zh/">
            
              Accelerate &#43; DeepSpeed/FSDP æ¡†æ¶ç¯‡
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/mftcoder-atorch-zh/">
            
              Atorchæ¡†æ¶ç¯‡
            
          </a>

        <strong class="sidebar-section">CodeFuse-MFT-VLM</strong>
          
          <a class="sidebar-link " href="/docs/codefuse-mft-vlm-quickstart-zh/">
            
              å¿«é€Ÿä½¿ç”¨
            
          </a>

        <strong class="sidebar-section">ğŸŒ± Test Agent</strong>
          
          <a class="sidebar-link " href="/docs/test-agent-quickstart-zh/">
            
              å¿«é€Ÿå¼€å§‹
            
          </a>

        <strong class="sidebar-section">ğŸŒ± CodeFuse-ModelCache</strong>
          
          <a class="sidebar-link " href="/docs/codefuse-modelcache-quickstart-zh/">
            
              å¿«é€Ÿå¼€å§‹
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/codefuse-modelcache-feature-zh/">
            
              åŠŸèƒ½ç‰¹æ€§
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/codefuse-modelcache-config-zh/">
            
              æœ€ä½³é…ç½®
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/codefuse-modelcache-release-zh/">
            
              ç‰ˆæœ¬è®°å½•
            
          </a>

        <strong class="sidebar-section">ğŸŒ± CodeFuse-ChatBot</strong>
          
          <a class="sidebar-link " href="/docs/codefuse-chatbot-quickstart-zh/">
            
              å¿«é€Ÿå¼€å§‹
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/%E5%90%AF%E5%8A%A8%E6%98%8E%E7%BB%86/">
            
              å¯åŠ¨æ˜ç»†
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/%E6%9C%AC%E5%9C%B0%E7%A7%81%E6%9C%89%E5%8C%96%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A5%E5%8F%A3%E6%8E%A5%E5%85%A5/">
            
              æœ¬åœ°ç§æœ‰åŒ–&amp;å¤§æ¨¡å‹æ¥å£æ¥å…¥
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/chatbot-%E6%8A%80%E6%9C%AF%E8%B7%AF%E7%BA%BF/">
            
              ChatBot æŠ€æœ¯è·¯çº¿
            
          </a>

        <strong class="sidebar-section">ğŸŒ± CodeFuse-DevOps-Model</strong>
          
          <a class="sidebar-link " href="/docs/codefuse-devops-model-train-zh/">
            
              è®­ç»ƒè§£æ
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/codefuse-devops-model-quickstart-zh/">
            
              å¿«é€Ÿä½¿ç”¨
            
          </a>

        <strong class="sidebar-section">ğŸŒ± CodeFuse-DevOps-Eval</strong>
          
          <a class="sidebar-link " href="/docs/%E6%95%B0%E6%8D%AE%E4%BB%8B%E7%BB%8D/">
            
              æ•°æ®ä»‹ç»
            
          </a>

        
          
          <a class="sidebar-link " href="/docs/codefuse-devops-eval-quickstart-zh/">
            
              å¿«é€Ÿå¼€å§‹
            
          </a>

        <strong class="sidebar-section">ğŸŒ± CodeFuse-evalution</strong>
          
          <a class="sidebar-link " href="/docs/codefuse-evalution-quickstart-zh/">
            
              å¿«é€Ÿå¼€å§‹
            
          </a>

        
  </div>
</aside>
  
  <main>
    <article id="article">
      <nav id="article-nav">
  <button id="article-nav-menu-btn"><i class="icon icon-menu"></i> On this section</button>
  
</nav>
      <header id="article-header">
  <h1>MFTCoder: Accelerate + DeepSpeed/FSDP æ¡†æ¶ç¯‡</h1>
</header>
      <div id="article-content">
        
        
        <p><a href="https://huggingface.co/codefuse-ai"><img src="https://img.shields.io/badge/%F0%9F%A4%97-Huggingface%20Repo-green.svg" alt="Generic badge" target="_blank"></a>
<a href="https://github.com/codefuse-ai/MFTCoder/blob/main/LICENSE" target="_blank">
<img alt="GitHub" src="https://img.shields.io/github/license/huggingface/transformers.svg?color=blue">
</a></p>
<p>[<strong>ä¸­æ–‡</strong>] <a href="/docs/mftcoder-accelerate">[English]</a></p>
<h2 id="1-æ›´æ–°">1. æ›´æ–°</h2>
<p>ğŸ”¥ MFTCoder-accelerate æ–°å¢æ”¯æŒaccelerate + FSDPæ¡†æ¶ï¼Œ æ”¯æŒå…¨é‡å¾®è°ƒå’ŒLoRA;</p>
<p>ğŸ”¥ MFTCoder-accelerate æ”¯æŒæœ€æ–°æ›´å¤šä¸»æµå¼€æºæ¨¡å‹: mistral, mixtral-8x7b(Mixture of Experts), deepseek, chatglm3ï¼›</p>
<p>ğŸ”¥ MFTCoder-accelerate æ–°å¢self-paced Loss, ç”¨äºæ”¶æ•›å‡è¡¡ï¼›</p>
<p>ğŸ”¥ MFTCoder-accelerate æ”¯æŒä½¿ç”¨accelerate + DeepSpeedæ¡†æ¶ä¸‹æ”¯æŒ å…¨é‡å‚æ•°/QLoRA/LoRAå¾®è°ƒï¼›</p>
<p>ğŸ”¥ MFTCoder-accelerate åœ¨è®­ç»ƒä¸­æ”¯æŒäº†å¤šä»»åŠ¡å¾®è°ƒMFTï¼Œ å¯ä»¥åŒæ—¶å¹³è¡¡å¤šä¸ªä»»åŠ¡çš„è®­ç»ƒï¼Œè®­ç»ƒçš„æ¨¡å‹æ”¯æŒå¤šä»»åŠ¡æ¨ç†ï¼›</p>
<p>ğŸ”¥ MFTCoder-accelerate åœ¨è®­ç»ƒä¸­æ”¯æŒå¤šç§æ¨¡å‹åŸºåº§ï¼š codellama, llama2, llama, starcoder, codegeex2, chatglm2, qwenç­‰</p>
<h2 id="2-æ•°æ®æ ¼å¼">2. æ•°æ®æ ¼å¼</h2>
<h3 id="21-è®­ç»ƒæ•°æ®æ ¼å¼">2.1 è®­ç»ƒæ•°æ®æ ¼å¼</h3>
<p>è®­ç»ƒæ•°æ®ä¸ºjsonlæ ¼å¼ï¼Œæ¯ä¸€è¡Œçš„æ•°æ®æ ¼å¼å¦‚ä¸‹ï¼Œå…¶ä¸­chat_roundså­—æ®µæ˜¯å¿…éœ€çš„ï¼Œå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚æ·»åŠ æˆ–åˆ é™¤å…¶ä»–å­—æ®µã€‚
å¯ä»¥å‚è€ƒé¡¹ç›®ä¸­çš„xxx.jsonlæ–‡ä»¶ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;id&#34;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;data_name&#34;</span><span class="p">:</span><span class="s2">&#34;code-helper&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;chat_rounds&#34;</span><span class="p">:[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;system&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½ä»£ç åŠ©æ‰‹ï¼Œå¯ä»¥å›å¤ç”¨æˆ·ä¸ä»£ç ç›¸å…³çš„é—®é¢˜&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;human&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;å†™ä¸€ä¸ªå¿«é€Ÿæ’åº&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;bot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;ä»¥ä¸‹æ˜¯ä¸€ä¸ªå¿«é€Ÿæ’åºç®—æ³•xxxxxx&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;human&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;è§£é‡Šä¸€ä¸‹è¿™æ®µä»£ç &#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;bot&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;å¥½çš„ï¼Œè¿™æ®µä»£ç xxx&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="22-æ¨ç†æ•°æ®æ ¼å¼">2.2 æ¨ç†æ•°æ®æ ¼å¼</h3>
<p>æ¨ç†æ•°æ®æ ¼å¼ä¸ºæ¨¡å‹åœ¨è®­ç»ƒæ•°æ®æ ¼å¼ä¸‹æ‹¼æ¥çš„å­—ç¬¦ä¸²å½¢å¼ï¼Œå®ƒä¹Ÿæ˜¯æ¨ç†æ—¶è¾“å…¥promptæ‹¼æ¥çš„æ–¹å¼ï¼š</p>
<pre tabindex="0"><code>&#34;&#34;&#34;
&lt;s&gt;system
è¿™æ˜¯SystemæŒ‡ä»¤
&lt;s&gt;human
è¿™æ˜¯ç¬¬1è½®ç”¨æˆ·è¾“å…¥çš„é—®é¢˜
&lt;s&gt;bot
è¿™æ˜¯ç¬¬1è½®æ¨¡å‹ç”Ÿæˆçš„å†…å®¹{EOS_TOKEN}
&lt;s&gt;human
è¿™æ˜¯ç¬¬2è½®ç”¨æˆ·è¾“å…¥çš„é—®é¢˜
&lt;s&gt;bot
è¿™æ˜¯ç¬¬2è½®æ¨¡å‹ç”Ÿæˆçš„å†…å®¹{EOS_TOKEN}
...
...
...
&lt;s&gt;human
è¿™æ˜¯ç¬¬nè½®ç”¨æˆ·è¾“å…¥çš„é—®é¢˜
&lt;s&gt;bot
{æ¨¡å‹ç°åœ¨è¦ç”Ÿæˆçš„å†…å®¹}{EOS_TOKEN}
&#34;&#34;&#34;
</code></pre><h2 id="3-æ¨¡å‹è®­ç»ƒ">3. æ¨¡å‹è®­ç»ƒ</h2>
<p>ç›®å‰æ”¯æŒå…¨é‡å‚æ•°(Full-parameters)æŒ‡ä»¤å¾®è°ƒã€QLoRAæŒ‡ä»¤å¾®è°ƒï¼ŒLoRAæŒ‡ä»¤å¾®è°ƒã€‚
ä¸€äº›ä¼˜ç§€çš„ä»£ç é¢„è®­ç»ƒæ¨¡å‹æƒé‡ï¼Œç†è®ºä¸Šï¼ŒHuggingFaceä¸Šå¼€æºçš„æ¨¡å‹ï¼Œå‡å¯ä½¿ç”¨æœ¬é¡¹ç›®è¿›è¡Œè®­ç»ƒï¼š</p>
<p>ğŸ¤— <a href="https://huggingface.co/codellama/CodeLlama-34b-Python-hf" target="_blank">æœ€æ–°ä»£ç é¢„è®­ç»ƒSOTAï¼ŒCodeLlama</a> ï¼šcode-llama-34bï¼Œ code-llama-34b-python, æ–°çš„SOTAåŸºåº§ã€‚</p>
<p>ğŸ¤— <a href="https://huggingface.co/bigcode/starcoder" target="_blank">10Bçº§åˆ«æœ€ä½³ä»£ç é¢„è®­ç»ƒæ¨¡å‹Starcoder</a> wizardCoder-15B, PanGu-coder2ç­‰å‰SOTAçš„åŸºåº§æ¨¡å‹ã€‚</p>
<p>ğŸ¤— <a href="https://huggingface.co/Qwen/Qwen-7B" target="_blank">å¤šè¯­è¨€èƒ½æ‰‹Qwen-7b</a> ï¼šé€‚ç”¨äºå¤šè¯­è¨€ä»»åŠ¡ï¼Œä¹Ÿé€‚ç”¨ä¸­æ–‡ä»»åŠ¡ã€‚è¿›è¡ŒæŒ‡ä»¤å¾®è°ƒæ—¶ã€‚</p>
<p><strong>mftcoder_accelerateæ–‡ä»¶ç»“æ„</strong></p>
<pre tabindex="0"><code>mftcoder_accelerate
       |
       src
          configs
          |
          data
          |
          model
          |
          *pefts*
          |
          tokenizer
          |
          utils
       |
       evals
</code></pre><p>æˆ‘ä»¬å°†è®­ç»ƒä¸­ä½¿ç”¨çš„å„ç§ç»„ä»¶æŠ½å–å‡ºæ¥ï¼Œä»¥ä¾¿åç»­çš„æ‰©å±•å’Œä¼˜åŒ–ï¼Œ è¯¦è§<code>src</code>ç›®å½•ä¸‹çš„å®ç°ã€‚</p>
<p>è®­ç»ƒå…¥å£æ–‡ä»¶æ˜¯<code>mftcoder_accelerate/src/pefts/mft_accelerate.py</code></p>
<p>å‚æ•°é…ç½®å­˜å‚¨åœ¨<code>mftcoder_accelerate/src/configs</code>ç›®å½•ä¸‹ï¼Œæ–¹ä¾¿ç»Ÿä¸€ç®¡ç†å’Œæ›´æ”¹ã€‚</p>
<p><strong><em>æ‰€ä»¥ï¼Œåœ¨ä½ å¼€å¯è®­ç»ƒä¹‹å‰ï¼Œè¯·è¿›å…¥srcç›®å½•</em></strong></p>
<pre tabindex="0"><code>cd mftcoder_accelerate/src
</code></pre><h3 id="31-æ•°æ®tokenization">3.1 æ•°æ®tokenization</h3>
<p>è®­ç»ƒæ—¶ï¼Œæˆ‘ä»¬å°†å¤šè½®å¯¹è¯æ‹¼æ¥æˆå¦‚ä¸‹æ ¼å¼ï¼ˆä¹Ÿæ˜¯ä¸Šæ–‡ä¸­çš„æ¨ç†æ•°æ®æ ¼å¼ï¼‰ï¼Œç„¶åè¿›è¡Œtokenizeã€‚
å…¶ä¸­ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼š</p>
<p><code>&lt;s&gt;human\n</code>ä½œä¸ºhuman/userçš„èµ·å§‹ç¬¦ï¼Œ<code>&lt;s&gt;bot\n</code>ä½œä¸ºbot/assistantçš„èµ·å§‹ç¬¦ï¼Œ<code>{EOS_TOKEN}</code> è¡¨ç¤ºeos_tokenã€‚
å…¶ä¸­eos_tokenå¯ä»¥æ ¹æ®ä¸åŒæ¨¡å‹ä¿®æ”¹æ›¿æ¢ã€‚ä¸åŒè§’è‰²çš„èµ·å§‹ç¬¦å¯ä»¥é…ç½®ï¼Œç”¨æ¥å®ç°ä¸åŒçš„å¯¹è¯/é—®ç­”æ¨¡ç‰ˆã€‚</p>
<pre tabindex="0"><code>&#34;&lt;s&gt;human\n{input1}&lt;s&gt;bot\n{target1}{EOS_TOKEN}&lt;s&gt;human\n{input2}&lt;s&gt;bot\n{target2}{EOS_TOKEN}\n&#34;
</code></pre><p>åœ¨è®¡ç®—lossæ—¶ï¼Œæˆ‘ä»¬é€šè¿‡loss maskçš„æ–¹å¼ï¼Œinputéƒ¨åˆ†çš„lossä¸å‚ä¸å‚æ•°æ›´æ–°ï¼Œåªæœ‰â€œtarget{EOS_TOKEN}â€éƒ¨åˆ†çš„losså‚ä¸å‚æ•°æ›´æ–°ã€‚
è¿™ç§æ–¹å¼å……åˆ†åˆ©ç”¨äº†æ¨¡å‹å¹¶è¡Œè®¡ç®—çš„ä¼˜åŠ¿ï¼Œè®­ç»ƒæ›´åŠ é«˜æ•ˆï¼ŒåŒæ—¶ä¹Ÿå……åˆ†åˆ©ç”¨äº†decoder-onlyæ¨¡å‹ä»å·¦åˆ°å³attentionçš„ç‰¹æ€§ï¼Œä¸€æ¬¡æ€§å°†å¤šè½®å¯¹è¯ä¸­çš„æ¯ä¸ªtargetéƒ¨åˆ†éƒ½å‚ä¸äº†è®­ç»ƒï¼Œè®­ç»ƒæ›´å……åˆ†é«˜æ•ˆã€‚</p>
<h3 id="32-loraqloraå¾®è°ƒ">3.2 LoRA/QLoRAå¾®è°ƒ</h3>
<h4 id="loraqloraå¾®è°ƒç®€ä»‹">LoRA/QLoRAå¾®è°ƒç®€ä»‹</h4>
<p>å…³äºLoRAçš„è¯¦ç»†ä»‹ç»å¯å‚è€ƒè®ºæ–‡ï¼š<a href="https://arxiv.org/pdf/2106.09685.pdf" target="_blank">LORA: LOW-RANK ADAPTATION OF LARGE LANGUAGE MODELS</a></p>
<p>å…³äºQLoRAçš„è¯¦ç»†ä»‹ç»å¯å‚è€ƒè®ºæ–‡ï¼š<a href="https://arxiv.org/pdf/2305.14314.pdf" target="_blank">QLORA: Efficient Finetuning of Quantized LLMs</a></p>
<p>QLoRAé€šè¿‡4-bitçš„nf4é‡åŒ–ï¼Œä¸”åŠ å…¥æ›´å¤šadapterï¼Œåœ¨å¤§å¹…å‡å°‘æ˜¾å­˜æ¶ˆè€—çš„åŒæ—¶ï¼Œå°½å¯èƒ½é€¼è¿‘å…¨é‡å‚æ•°å¾®è°ƒçš„æ•ˆæœã€‚
QLoRAè®ºæ–‡æŒ‡å‡ºï¼Œè¯¥æ–¹æ³•å¯ä»¥åœ¨ä¸€å¼ V100ä¸Šå¯¹33Bçš„æ¨¡å‹è¿›è¡Œå¾®è°ƒï¼Œå¹¶ä¸”æ€§èƒ½é€¼è¿‘å…¨é‡å‚æ•°å¾®è°ƒã€‚</p>
<p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯è¿›è¡Œ Lora/QLora/å…¨é‡ å¾®è°ƒï¼š</p>
<h4 id="launch-via-deepspeed">Launch via Deepspeed</h4>
<p>DeepSpeedé…ç½®åœ¨accelerate_ds_config.yamlä¸­ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">accelerate launch --config_file accelerate_ds_config.yaml pefts/mft_accelerate.py --train_config configs/xxx_train_config.json --distributed_type <span class="s2">&#34;DeepSpeed&#34;</span> 
</span></span></code></pre></div><p>æˆ–è€…</p>
<p>DeepSpeedé…ç½®åœ¨è„šæœ¬ä¸­é€šè¿‡å‘½ä»¤è¡Œè¾“å…¥ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sh ds_single_launch.sh
</span></span></code></pre></div><h4 id="launch-via-fsdp">Launch via FSDP</h4>
<p>FSDPé…ç½®åœ¨accelerate_fsdp_config.yamlä¸­ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">accelerate launch --config_file accelerate_fsdp_config.yaml pefts/mft_accelerate.py --train_config configs/xxx_train_config.json --distributed_type <span class="s2">&#34;FSDP&#34;</span>
</span></span></code></pre></div><p>æˆ–è€…</p>
<p>FSDPé…ç½®åœ¨è„šæœ¬ä¸­é€šè¿‡å‘½ä»¤è¡Œè¾“å…¥ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sh fsdp_single_launch.sh
</span></span></code></pre></div><h4 id="è®­ç»ƒå‚æ•°">è®­ç»ƒå‚æ•°</h4>
<p><em><strong>è®­ç»ƒéœ€è¦çš„å‚æ•°é…ç½®åœ¨<code>configs/*_train_config</code>ä¸­ï¼Œä¸»è¦å‚æ•°è¯´æ˜å¦‚ä¸‹ï¼š</strong></em></p>
<ul>
<li><strong>load_raw_dataset</strong>: éœ€è¦ä¿æŒtrueï¼Œåç»­ä¼šæ”¯æŒå…¶å®ƒæ¨¡å¼æ•°æ®ï¼Œå½“å‰ä»…æ”¯æŒjsonlè¾“å…¥</li>
<li><strong>data_paths</strong>: &ldquo;[path1,path2,path3]&rdquo; è¾“å…¥æ•°æ®åœ°å€ï¼Œå­—ç¬¦ä¸²ï¼Œå¼€å¤´ç»“å°¾ç”¨[]ï¼Œä¸­é—´ç”¨<code>,</code>é—´éš”ä¸åŒpathï¼Œæ¯ä¸ªpathæ˜¯ä¸€ä¸ªç›®å½•ï¼Œç›®å½•çš„æœ€åä¸€çº§åå­—ä½œä¸ºä»»åŠ¡åç§°ï¼Œä¸‹é¢åŒ…å«1åˆ°å¤šä¸ªjsonlæ•°æ®</li>
<li><strong>output_dir</strong>ï¼šè®­ç»ƒè¾“å‡ºç›®å½•ï¼Œå­˜å‚¨checkpoint(å…¨é‡è®­ç»ƒæ—¶)ã€lora_adaptorï¼ˆLoraæˆ–è€…Qloraæ—¶ï¼‰ç­‰</li>
<li><strong>tb_dir</strong>: å­˜å‚¨tensorboardç­‰</li>
<li><strong>model_type</strong>: &ldquo;mixtral|mistral|deepseek|llama|starcoder|chatglm2|qwen|gpt_neox&rdquo;</li>
<li><strong>attn_implementation</strong>: &ldquo;flash_attention_2&rdquo; æˆ–è€… &ldquo;eager&rdquo;</li>
<li><strong>peft_type</strong>: loraæˆ–è€…qloraæˆ–è€…null(å…¨é‡å¾®è°ƒ)</li>
<li><strong>lora_rank</strong>: lora rank</li>
<li><strong>lora_alpha</strong>: lora alpha</li>
<li><strong>lora_dropout</strong>: lora dropout</li>
<li><strong>target_modules</strong>: List[str], loraç›®æ ‡æ¨¡å—ï¼Œå¦‚æœnullï¼Œä¼šä½¿ç”¨é»˜è®¤ï¼Œå‚è€ƒmodel_mapping.py</li>
<li><strong>quantization</strong>: æ˜¯å¦é‡åŒ–ï¼Œ&ldquo;4bit&rdquo;, &ldquo;8bit&rdquo; æˆ–è€…nullï¼Œ qloraæ¨è4bité‡åŒ–</li>
<li><strong>pretrained_model_path</strong>ï¼šé¢„è®­ç»ƒæ¨¡å‹çš„æœ¬åœ°ç›®å½•ï¼Œæˆ–è€…åœ¨huggingfaceä¸Šçš„æ¨¡å‹åç§°ã€‚</li>
<li><strong>weighted_loss_mode</strong>: å¤šä»»åŠ¡lossåŠ æƒæ¨¡å¼ï¼Œ &ldquo;case3&quot;æ˜¯å½“å‰æ¨èã€‚</li>
<li><strong>padding_mode</strong>: æ•°æ®çš„æ ·æœ¬ç»„ç»‡æ–¹å¼ï¼Œ &ldquo;padding&quot;æ˜¯å°†æ¯ä¸ªåŸå§‹æ ·æœ¬å¡«å……åˆ°seq_length, &ldquo;pack&quot;æ˜¯å°†å°½é‡å¤šçš„æ ·æœ¬æ‰“åŒ…åˆ°æ¯ä¸ªseq_lengthçš„åºåˆ—ä¸­ã€‚</li>
<li><strong>num_train_epochs</strong>ï¼šè®­ç»ƒçš„è½®æ¬¡ã€‚å¦‚æœæ•°æ®é‡è¶³å¤Ÿå¤§ï¼Œä¸€èˆ¬å»ºè®®åªè®­1-2ä¸ªepochã€‚</li>
<li><strong>per_device_train_batch_size</strong>ï¼šæ¯å¼ æ˜¾å¡trainçš„batch sizeã€‚</li>
<li><strong>per_device_eval_batch_size</strong>ï¼šæ¯å¼ æ˜¾å¡evalçš„batch sizeã€‚</li>
<li><strong>gradient_accumulation_steps</strong>ï¼šæ¢¯åº¦ç´¯è®¡æ­¥æ•°ã€‚global batch=num_gpus * per_device_train_batch_size * gradient_accumulation_stepsã€‚</li>
<li><strong>learning_rate</strong>ï¼šå­¦ä¹ ç‡ã€‚å…¨é‡å‚æ•°å¾®è°ƒçš„æ—¶å€™ï¼Œå»ºè®®å°ä¸€äº›ï¼Œ1e-5æˆ–5e-6ã€‚qloraä¸­çš„å­¦ä¹ ç‡è®¾ç½®æ›´å¤§ä¸€äº›ï¼Œä¸€èˆ¬ä¸º1e-4ã€2e-4ã€‚</li>
<li><strong>min_lr</strong>: æœ€ä½å­¦ä¹ ç‡ï¼Œ ä¸€èˆ¬æ˜¯learning_rateçš„ååˆ†ä¹‹ä¸€</li>
<li><strong>seq_length</strong>ï¼šè®­ç»ƒæ—¶çš„æœ€å¤§é•¿åº¦ã€‚æŒ‰ç…§è‡ªå·±çš„è®¾å¤‡è¿›è¡Œè®¾ç½®ï¼Œè¶Šé•¿éœ€è¦å ç”¨è¶Šå¤šæ˜¾å­˜ã€‚</li>
<li><strong>log_interval</strong>ï¼šæ¯éš”å¤šå°‘æ­¥ç»Ÿè®¡ä¸€æ¬¡train lossã€‚</li>
<li><strong>checkpointing_steps</strong>ï¼šæ¯éš”å¤šå°‘æ­¥ä¿å­˜ä¸€ä¸ªæ¨¡å‹ã€‚</li>
<li><strong>evaluation_steps</strong>ï¼šæ¯éš”å¤šå°‘æ­¥åœ¨éªŒè¯é›†ä¸Ševaluateä¸€æ¬¡ã€‚</li>
<li><strong>early_stopping</strong> ï¼š æ˜¯å¦æ‰§è¡Œearly_stop</li>
<li><strong>early_stopping_stall_num</strong>ï¼š å¤šå°‘ä¸ªeval pointä¸ç»§ç»­æ”¶æ•›ï¼Œåˆ™åœæ­¢è®­ç»ƒ</li>
<li><strong>lr_scheduler_type</strong>ï¼šå­¦ä¹ ç‡å˜åŒ–ç­–ç•¥ã€‚å¸¸ç”¨&quot;cosine&rdquo;</li>
<li><strong>warmup_steps</strong>ï¼šwarm upæ­¥æ•°ã€‚å­¦ä¹ ç‡ç»è¿‡å¤šå°‘æ­¥ï¼Œå¢é•¿åˆ°æŒ‡å®šçš„æ•°å€¼ã€‚</li>
<li><strong>seed</strong>ï¼šéšæœºç§å­ï¼Œç”¨äºå¤ç°å®éªŒç»“æœã€‚</li>
<li><strong>saving_limit</strong>ï¼šæ•´æ•°ï¼Œckptå­˜å‚¨æ•°é‡ä¸Šé™ï¼Œ å…¨é‡è®­ç»ƒå¿…é¡»è®¾ç½®ã€‚é»˜è®¤nullå³ä¸é™åˆ¶æ•°é‡ã€‚</li>
<li><strong>role_markers</strong>: nullï¼Œå³ä½¿ç”¨{&ldquo;system&rdquo;: &ldquo;&lt;s&gt;system\n&rdquo;, &ldquo;user&rdquo;: &ldquo;&lt;s&gt;human\n&rdquo;, &ldquo;assistant&rdquo;: &ldquo;&lt;s&gt;bot\n&rdquo;}ã€‚ ä½ å¯ä»¥è‡ªå®šä¹‰ &ldquo;system&rdquo;, &ldquo;user&rdquo; and &ldquo;assistant&quot;çš„æ¨¡æ¿ï¼Œ ç”¨äºå®šåˆ¶è‡ªå·±çš„é—®ç­”æˆ–è€…å¯¹è¯æ¨¡æ¿ï¼Œæ¯”å¦‚ {&ldquo;system&rdquo;: &ldquo;### System:\n&rdquo;, &ldquo;user&rdquo;: &ldquo;### Instruction:\n&rdquo;, &ldquo;assistant&rdquo;: &ldquo;### Response:\n&rdquo;}</li>
</ul>
<h2 id="4-æ¨¡å‹ä½¿ç”¨">4. æ¨¡å‹ä½¿ç”¨</h2>
<h3 id="41-æƒé‡åˆå¹¶">4.1 æƒé‡åˆå¹¶</h3>
<p>å¦‚æœä½¿ç”¨LoRAæˆ–è€…QLoRAè¿›è¡Œè®­ç»ƒï¼Œæœ¬é¡¹ç›®ä»…ä¿å­˜adapterçš„æƒé‡å’Œé…ç½®æ–‡ä»¶ï¼Œéœ€è¦å°†adapteræƒé‡ä¸base modelè¿›è¡Œåˆå¹¶ã€‚
å¯ä»¥ä½¿ç”¨å¦‚ä¸‹merge_base_and_lora_to_hf.pyè„šæœ¬ã€‚</p>
<pre tabindex="0"><code>python pefts/merge_base_and_lora_to_hf.py \
    --base_model_or_path model_path \
    --adaptor_path lora_adapter_path \
    --model_type model_type \
    --merged_output_path output_path
</code></pre><h3 id="42-æ¨¡å‹æ¨ç†">4.2 æ¨¡å‹æ¨ç†</h3>
<p>æˆ‘ä»¬æä¾›äº†å•è½®å¯¹è¯å’Œå¤šè½®å¯¹è¯çš„å¦‚ä¸‹è„šæœ¬ï¼Œè¯¥è„šæœ¬å¯åŒæ—¶å…¼å®¹å¤§éƒ¨åˆ†huggingfaceæ ¼å¼çš„æ¨¡å‹ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">AutoTokenizer</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">AutoModelForCausalLM</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">model_name_or_path</span> <span class="o">=</span> <span class="s2">&#34;codefuse-ai/CodeFuse-Deepseek-33B&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">padding_side</span><span class="o">=</span><span class="s2">&#34;left&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">convert_tokens_to_ids</span><span class="p">(</span><span class="s2">&#34;&lt;ï½œendâ–ofâ–sentenceï½œ&gt;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span>
</span></span><span class="line"><span class="cl"><span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name_or_path</span><span class="p">,</span> <span class="n">trust_remote_code</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HUMAN_ROLE_START_TAG</span> <span class="o">=</span> <span class="s2">&#34;&lt;s&gt;human</span><span class="se">\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">BOT_ROLE_START_TAG</span> <span class="o">=</span> <span class="s2">&#34;&lt;s&gt;bot</span><span class="se">\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;write a python function of quick sort.&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">HUMAN_ROLE_START_TAG</span><span class="si">}{</span><span class="n">text</span><span class="si">}{</span><span class="n">BOT_ROLE_START_TAG</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">inputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s1">&#39;pt&#39;</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">add_special_tokens</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&#34;cuda&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&#34;input_ids&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">attention_mask</span><span class="o">=</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&#34;attention_mask&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">top_p</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">eos_token_id</span><span class="o">=</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">pad_token_id</span><span class="o">=</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">gen_text</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">outputs</span><span class="p">[:,</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&#34;input_ids&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:],</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">gen_text</span><span class="p">)</span>
</span></span></code></pre></div><p>ç”Ÿæˆè„šæœ¬ä¸­çš„top_pã€temperatureã€repetition_penaltyã€do_sampleç­‰å‚æ•°å¯¹æ¨¡å‹çš„ç”Ÿæˆæ•ˆæœå½±å“è¾ƒå¤§ï¼Œå¯æŒ‰ç…§è‡ªå·±çš„ä½¿ç”¨åœºæ™¯è¿›è¡Œè°ƒè¯•ä¿®æ”¹ã€‚
å®è·µä¸­ï¼Œåœ¨ä»£ç ç”Ÿæˆåœºæ™¯ä¸­ï¼Œå¦‚æœé‡‡æ ·æ¨¡å¼ï¼Œdo_sample=True, top_p=0.95, temperature=0.1æ˜¯pass@1æŒ‡æ ‡çš„ä¸é”™é€‰æ‹©ï¼›
å¦‚æœéé‡‡æ ·æ¨¡å¼ï¼Œ do_sample=False, beam_num=1æˆ–è€…3æ˜¯ä¸é”™çš„é€‰æ‹©ï¼Œå…¶ä¸­beam_num=1å³ä¸ºgreedy decodingã€‚</p>
<h2 id="5-faq">5. FAQ</h2>
<h4 id="é—®é¢˜1oomå¦‚ä½•è§£å†³">é—®é¢˜1ï¼šOOMå¦‚ä½•è§£å†³ï¼Ÿ</h4>
<p>å¦‚æœå‘ç”ŸOOMï¼Œå¯ä»¥ç¼©å°per_device_train_batch_sizeã€seq_lengthç­‰å‚æ•°æ¥ç¼“è§£ã€‚ç”±äºé¢å¯¹çš„æ¨¡å‹æ™®éè¾ƒå¤§ï¼ˆ6bï¼Œ 13bï¼Œ 34bï¼Œ 70bç­‰ï¼‰æˆ‘ä»¬å·²ç»é»˜è®¤ä½¿ç”¨gradient_checkpointingæŠ€æœ¯ï¼Œå¯ä»¥å¤§å¹…é™ä½æ˜¾å­˜å ç”¨ï¼Œä½†è®­ç»ƒé€Ÿåº¦ä¼šç¨æ…¢ä¸€äº›ã€‚</p>
<h4 id="é—®é¢˜2å®‰è£…åŒ…é”™è¯¯">é—®é¢˜2ï¼šå®‰è£…åŒ…é”™è¯¯</h4>
<p>å‚è€ƒinit_env.shå’Œrequirements.txt</p>
<h4 id="é—®é¢˜3å¦‚ä½•æŒ‡å®šä½¿ç”¨æŸäº›å¡è®­ç»ƒ">é—®é¢˜3ï¼šå¦‚ä½•æŒ‡å®šä½¿ç”¨æŸäº›å¡è®­ç»ƒï¼Ÿ</h4>
<p>é€šè¿‡å¦‚ä¸‹æ–¹å¼ï¼Œå³å¯æŒ‡å®šä½¿ç”¨0å’Œ1å·å¡è¿›è¡Œè®­ç»ƒ:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span>0,1 accelerate launch --config_file pefts/accelerate_ds_config.yaml pefts/mft_accelerate.py --train_config configs/xxx_train_config.json --distributed_type <span class="s2">&#34;deepspeed&#34;</span>
</span></span></code></pre></div><h4 id="é—®é¢˜4å…³äºflash-attention-è¯¥å¦‚ä½•é…ç½®è®­ç»ƒ">é—®é¢˜4ï¼šå…³äºFlash Attention, è¯¥å¦‚ä½•é…ç½®è®­ç»ƒï¼Ÿ</h4>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å¼ºçƒˆå»ºè®®æ‚¨å®‰è£…Flash Attention 2(FA2)ï¼Œï¼ˆ&gt;=2.1.0, 2.3.6åŠŸèƒ½æ›´é½å…¨ï¼‰ã€‚</p>
<p>è®­ç»ƒå‚æ•°ä¸­&quot;attn_implementation&rdquo; è®¾ç½®æˆ &ldquo;eager&rdquo; å¯ä»¥ç”¨naive attentionï¼Œä¹Ÿå°±æ˜¯æœªç»åŠ é€Ÿçš„attentionã€‚</p>
<p>è®­ç»ƒå‚æ•°ä¸­&quot;attn_implementation&rdquo; è®¾ç½®æˆ &ldquo;flash_attention_2&rdquo; å¯ä»¥ç”¨FA2ï¼Œé€Ÿåº¦å¿«ï¼Œçœæ˜¾å­˜ã€‚</p>
<p>å¦‚æœä½ å¯ä»¥è‡ªè¡Œå®‰è£…ç¯å¢ƒå¹¶ä½¿ç”¨torch&gt;=2.1.1ï¼Œå¯ä»¥å°è¯•è®¾ç½®å‚æ•°&quot;attn_implementation&quot;ä¸º &ldquo;sdpa&rdquo;ã€‚è¿™æ ·ä¼šå°è¯•ä½¿ç”¨transformerså…¼å®¹çš„torch.nn.functional.scaled_dot_product_attentionã€‚æ”¯æŒçš„æ¨¡å‹è¿˜ä¸å…¨é¢ã€‚</p>
<h4 id="é—®é¢˜5æ¨èçš„åˆ†å¸ƒå¼æ¡†æ¶æ˜¯æ€æ ·çš„">é—®é¢˜5ï¼šæ¨èçš„åˆ†å¸ƒå¼æ¡†æ¶æ˜¯æ€æ ·çš„ï¼Ÿ</h4>
<p>å¯¹äºLoRA/QLoRA, æˆ‘ä»¬æ¨èä½¿ç”¨DeepSpeedä½œä¸ºåº•å±‚åˆ†å¸ƒå¼æ¡†æ¶ï¼Œå®ƒå…·æœ‰æ˜“ç”¨æ€§å’Œå…¼å®¹æ€§å¥½çš„ç‰¹ç‚¹ï¼Œå¹¶ä¸”é€Ÿåº¦å¾ˆå¿«ã€‚
FSDP ä¸æ”¯æŒQLoRA, å› ä¸ºbitsandbytesæš‚ä¸æ”¯æŒFSDPã€‚</p>
<p>å¯¹äºå…¨é‡å¾®è°ƒï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨FSDPï¼Œ å› ä¸ºå®ƒåœ¨å…¨é‡è®­ç»ƒæ—¶å¯ä»¥å‘æŒ¥fully shardingçš„ä¼˜åŠ¿ï¼Œè¾¾åˆ°æ›´å¿«çš„è®­ç»ƒé€Ÿåº¦ã€‚</p>
<h4 id="é—®é¢˜6å½“å‰æ”¯æŒçš„æ¨¡å‹ä¸­æœ‰ä»€ä¹ˆåŒºåˆ«">é—®é¢˜6ï¼šå½“å‰æ”¯æŒçš„æ¨¡å‹ä¸­ï¼Œæœ‰ä»€ä¹ˆåŒºåˆ«</h4>
<p>å›½äº§å¤§æ¨¡å‹æ¯”å¦‚chatglm2ï¼Œ chatglm3ï¼Œ baichuan2ï¼Œ qwenï¼Œ aquila2ç­‰ï¼Œä½¿ç”¨çš„æ˜¯å’Œæ¨¡å‹å…±åŒå‘å¸ƒçš„modeling_xxx.py.
å…¶å®ƒè¢«transformerså®˜æ–¹æ”¯æŒçš„å¤§æ¨¡å‹ï¼Œç”±äºå·²ç»å‡çº§æ”¯æŒflash attentionç­‰ï¼Œæ‰€ä»¥å…¨é¢åˆ‡æ¢åˆ°å®˜æ–¹çš„modelingæ”¯æŒè®­ç»ƒï¼Œä¹‹å‰çš„è‡ªå®šä¹‰modelingä¼šè¢«deprecated</p>

      </div>
      








  
  
  
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

        
          
        

      
    
        

      
    
        

        
          
        

        
        
      


<footer id="article-footer">
  <time id="article-last-updated" datetime="2024-04-09"><i class="icon icon-calendar"></i>&nbsp;Last updated: 2024-04-09</time>

  
    <a id="article-prev-link" href="/docs/mftcoder-quickstart-zh/"><i class="icon icon-prev icon-colored"></i> Prev</a>
  

  
    <a id="article-next-link"  href="/docs/mftcoder-atorch-zh/">Next <i class="icon icon-next icon-colored"></i></a>
  
</footer>
    </article>
    <aside id="toc">
  <span class="btn-close"><i class="icon icon-close"></i></span>
  <div class="sticky">
    <strong><i class="icon icon-toc"></i> On this page</strong>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#1-æ›´æ–°">1. æ›´æ–°</a></li>
    <li><a href="#2-æ•°æ®æ ¼å¼">2. æ•°æ®æ ¼å¼</a>
      <ul>
        <li><a href="#21-è®­ç»ƒæ•°æ®æ ¼å¼">2.1 è®­ç»ƒæ•°æ®æ ¼å¼</a></li>
        <li><a href="#22-æ¨ç†æ•°æ®æ ¼å¼">2.2 æ¨ç†æ•°æ®æ ¼å¼</a></li>
      </ul>
    </li>
    <li><a href="#3-æ¨¡å‹è®­ç»ƒ">3. æ¨¡å‹è®­ç»ƒ</a>
      <ul>
        <li><a href="#31-æ•°æ®tokenization">3.1 æ•°æ®tokenization</a></li>
        <li><a href="#32-loraqloraå¾®è°ƒ">3.2 LoRA/QLoRAå¾®è°ƒ</a></li>
      </ul>
    </li>
    <li><a href="#4-æ¨¡å‹ä½¿ç”¨">4. æ¨¡å‹ä½¿ç”¨</a>
      <ul>
        <li><a href="#41-æƒé‡åˆå¹¶">4.1 æƒé‡åˆå¹¶</a></li>
        <li><a href="#42-æ¨¡å‹æ¨ç†">4.2 æ¨¡å‹æ¨ç†</a></li>
      </ul>
    </li>
    <li><a href="#5-faq">5. FAQ</a>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</aside>
  </main>
</div>

    <footer id="site-footer">
  
  <div id="site-footer-copyright">
    <a href="https://github.com/codefuse-ai" target="_blank">
      <i class="icon icon-copyright"></i> 2023-2024 codefuse-ai
    </a>
  </div>

  
  <div id="site-footer-social">

    

    

    
    <a href="https://github.com/codefuse-ai" target="_blank" aria-label="github url">
      <i class="icon icon-github icon-colored"></i>
    </a>
    

    

  </div>

  
  <div id="site-footer-fund">

    

    

  </div>

  
  <div id="site-footer-love">
    Made with <i class="icon icon-love icon-colored"></i> &nbsp;from&nbsp;<a href="https://docura.github.io/" target="_blank">Docura</a>
  </div>
</footer>
    






<script type="text/javascript" src="/js/base.min.js"></script>




<script type="application/javascript">
    if('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js?2024-04-09')
            .catch(function(err) {console.error('ServiceWorker registration failed: ', err);});
    }
</script>
  </body>
</html>